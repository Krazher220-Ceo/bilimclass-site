import requests
import os
from flask import Flask, render_template, request
from datetime import datetime, timedelta
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env
load_dotenv()

USERNAME = os.getenv("USERNAME")
PASSWORD = os.getenv("PASSWORD")
SCHOOL_ID = os.getenv("SCHOOL_ID", "1006693")
EDU_YEAR = os.getenv("EDU_YEAR", "2024")
STUDENT_GROUP_UUID = os.getenv("STUDENT_GROUP_UUID", "2666df86-ee3e-4d22-aa76-052f3fedf057")

LOGIN_URL = "https://api.bilimclass.kz/api/v2/os/login"
HOMEWORK_URL = f"https://api.bilimclass.kz/api/v4/os/clientoffice/homeworks/monthly/list?schoolId={SCHOOL_ID}&eduYear={EDU_YEAR}&studentGroupUuid={STUDENT_GROUP_UUID}"

app = Flask(__name__, template_folder="templates")

def get_new_token():
    """üîπ –ü–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–≥–æ –≤ .env"""
    print("üîπ –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞...")
    payload = {"login": USERNAME, "password": PASSWORD}
    
    print(f"üîπ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–≥–∏–Ω: {USERNAME}, –ø–∞—Ä–æ–ª—å: {PASSWORD}")  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–Ω–∞ –∏ –ø–∞—Ä–æ–ª—è

    response = requests.post(LOGIN_URL, json=payload)
    
    print(f"üîπ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: {response.status_code} - {response.text}")  # –í—ã–≤–æ–¥–∏–º –æ—Ç–≤–µ—Ç API

    if response.status_code == 200 and response.json().get("success"):
        data = response.json()
        access_token = data.get("access_token", "")

        with open(".env", "w") as env_file:
            env_file.write(f"TOKEN={access_token}\n")
            env_file.write(f"USERNAME={USERNAME}\n")
            env_file.write(f"PASSWORD={PASSWORD}\n")
            env_file.write(f"SCHOOL_ID={SCHOOL_ID}\n")
            env_file.write(f"EDU_YEAR={EDU_YEAR}\n")
            env_file.write(f"STUDENT_GROUP_UUID={STUDENT_GROUP_UUID}\n")
        
        os.environ["TOKEN"] = access_token  # –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
        print(f"‚úÖ –ù–æ–≤—ã–π —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω: {access_token}")
        return access_token
    else:
        print("‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏! –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å.")
        return None

def get_headers():
    """üîπ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å —Ç–æ–∫–µ–Ω–æ–º"""
    token = os.getenv("TOKEN") or get_new_token()

    if not token:
        print("‚ùå –û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return {}

    return {"Authorization": f"Bearer {token}"}

def get_homework():
    """üîπ –ü–æ–ª—É—á–∞–µ—Ç –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ —Å API BilimClass"""
    headers = get_headers()
    
    if not headers:
        print("‚ùå –û—à–∏–±–∫–∞: –Ω–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞")
        return []
    
    response = requests.get(HOMEWORK_URL, headers=headers)

    if response.status_code == 401:  # –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –ø—Ä–æ—Å—Ä–æ—á–µ–Ω
        print("üîÑ –¢–æ–∫–µ–Ω –ø—Ä–æ—Å—Ä–æ—á–µ–Ω, –ø–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π...")
        os.environ["TOKEN"] = get_new_token()
        headers = get_headers()
        response = requests.get(HOMEWORK_URL, headers=headers)

    try:
        data = response.json()
        print(f"üìå –û—Ç–≤–µ—Ç API (–î–ó): {data}")  # –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç API
        return data.get("data", [])
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ JSON (–î–ó): {e}")
        return []

def filter_homework_by_date(homeworks, date):
    """üîπ –§–∏–ª—å—Ç—Ä—É–µ—Ç –î–ó –ø–æ –¥–∞—Ç–µ"""
    return [hw for hw in homeworks if hw.get("date") == date]

@app.route("/", methods=["GET", "POST"])
def index():
    homeworks = get_homework()
    
    if not homeworks:
        return "‚ùå –û—à–∏–±–∫–∞: API –Ω–µ –≤–µ—Ä–Ω—É–ª–æ –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ!", 500

    subjects = sorted(set(hw["subjectName"] for hw in homeworks if "subjectName" in hw))

    today = datetime.today().strftime("%d.%m.%Y")
    yesterday = (datetime.today() - timedelta(days=1)).strftime("%d.%m.%Y")

    homeworks_today = filter_homework_by_date(homeworks, today)
    homeworks_yesterday = filter_homework_by_date(homeworks, yesterday)

    selected_subject = request.form.get("subject")
    filtered_homeworks = [hw for hw in homeworks if hw.get("subjectName") == selected_subject] if selected_subject else []

    return render_template(
        "index.html",
        subjects=subjects,
        selected_subject=selected_subject,
        homeworks=filtered_homeworks,
        homeworks_today=homeworks_today,
        homeworks_yesterday=homeworks_yesterday
    )

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 10000))
    app.run(host="0.0.0.0", port=port)



